<!DOCTYPE html>
<html>
<head>
  <title>Dyad Finder</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <style>
    * {
    }

    body {
      background-image: linear-gradient(-90deg,#1251AE 0,#0074FF 50%,#1251AE 100%);
      font-family: 'Roboto';
      font-size: 22px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 500;
    }

    div.screen {
    }

    .headline {
      text-align: center;
    }

    #loading {
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    /**
     * Start Screen
     */

    .start {
      background-color: white;
      background-image: none;
      opacity: 1;
      padding: 25px 30px;
      margin: 2rem;
      width: 680px;
      display: flex;
      align-items: center;
    }

    .start-input-container {
      border-width: 0 0 2px;
      border-style: solid;
      border-image: linear-gradient(to right, #dee1e6, #fff) 1;
      width: 100%;
      align-items: center;
    }

    .start-input-container input {
      border: none;
      display: inline-block;
      width: 100%;
      font-size: 14px; 
    }

    .start-input-container input:focus {
      outline: none;
    }

    .start-title {
      font-size: 18px;
      font-weight: 700;
      padding-bottom: 5px;
    }

    .start-button {
      width: 51px;
      height: 35px;
      font-size: 14px;
      background: #0074e0;
      border-radius: 4px;
      color: white;
      text-align: center;
      line-height: 35px;
      cursor: pointer;
      vertical-align: middle;
    }

  </style>
</head>
<body onload="start()">
  <div id="loading" style="display: none" class="screen">
    <style>
      .lds-grid {
        width: 80px;
        height: 80px;
        top: 25%;
        display: inline-block;
        position: relative;
      }

      .lds-grid div {
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #cef;
        animation: lds-grid 1.2s linear infinite;
      }
      .lds-grid div:nth-child(1) {
        top: 8px;
        left: 8px;
        animation-delay: 0s;
      }
      .lds-grid div:nth-child(2) {
        top: 8px;
        left: 32px;
        animation-delay: -0.4s;
      }
      .lds-grid div:nth-child(3) {
        top: 8px;
        left: 56px;
        animation-delay: -0.8s;
      }
      .lds-grid div:nth-child(4) {
        top: 32px;
        left: 8px;
        animation-delay: -0.4s;
      }
      .lds-grid div:nth-child(5) {
        top: 32px;
        left: 32px;
        animation-delay: -0.8s;
      }
      .lds-grid div:nth-child(6) {
        top: 32px;
        left: 56px;
        animation-delay: -1.2s;
      }
      .lds-grid div:nth-child(7) {
        top: 56px;
        left: 8px;
        animation-delay: -0.8s;
      }
      .lds-grid div:nth-child(8) {
        top: 56px;
        left: 32px;
        animation-delay: -1.2s;
      }
      .lds-grid div:nth-child(9) {
        top: 56px;
        left: 56px;
        animation-delay: -1.6s;
      }
      @keyframes lds-grid {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
    <div class="lds-grid"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
  </div>
  <div id="select-group" style="display: none" class="screen">
    <div class="headline">
      <h1>Dyad Finder</h1>
    </div>
    <div class="start">
      <div class="start-input-container">
        <div class="start-title">
          Select Group
        </div>
        <input type="text" id="group-name"></input>
      </div>
      <div class="start-button default" onclick="navigateToGroup()">GO</div>
    </div>
  </div>
  <div id="populate-group" style="display:none" class="screen">
    <p>Populate Group <span id="display-group-name"></span></p>
    <div id="group-members">
    </div>
    <input type="text" id="member-name"></input>
    <button type="submit" class="default" onclick="addMemberToGroup()">Add Member</button>
    <div>
      <button type="submit" onclick="updateGroup()">Update Group</button>
    </div>
  </div>
  <div id="enter-preferences" style="display: none" class="screen">
    <div id="me">
      <p>Select your name</p>
    </div>
    <hr/>
    <div id="them">
    </div>
    <hr/>
    <div id="unselected">
    </div>
    <hr/>
    <p onclick="sendResults()">Submit</p>
  </div>
  <div id="thank-you" style="display:none" class="screen">
    <p>Thank you!</p>
  </div>
  <div id="error" style="display:none" class="screen">
    <p>Error - please try again</p>
  </div>
</body>
<script>

  var myName;

  var BASE_URL = "https://europe-west1-dyad-finder.cloudfunctions.net/dyad";

  var names = [
  ];

  function getPath() {
    if (window.location.protocol == "file:") {
      if (window.location.hash != "") {
        return window.location.hash.substring(1);
      }
      return window.location.hash;
    } else {
      return window.location.pathname.substring(1);
    }
  };

  function setPath(newGroupName) {
    var newPath;
    if (window.location.protocol == 'https:') {
      newPath = newGroupName
    } else {
      newPath = "#" + newGroupName;
    }
    history.pushState({}, "Group " + newGroupName, newPath);
  };

  function getGroupName() {
    return getPath();
  };

  function groupURL() {
    return BASE_URL + "/group/" + getGroupName();
  };

  function preferenceURL() {
    return groupURL() + "/preference"; 
  };

  function getGroupMembers() {
    return $.ajax({
      url: groupURL(),
      dataType: 'json'
    }).then(function(data, textStatus, jqXHR) {
      return data;
    });
  };

  function updateGroup() {
    $('#populate-group input, #populate-group button').prop("disabled", true);
    $.ajax({
      url: groupURL(),
      method: 'post',
      data: JSON.stringify({members: names}),
      contentType: 'application/json',
      dataType: "json"
    }).done(function() {
      $('#populate-group input, #populate-group button').prop("disabled", false);
      console.log("Selecting screen");
      selectScreen();
    }).fail(function(jqXHR, textStatus, error) {
      $('#populate-group input, #populate-group button').prop("disabled", false);
      console.log("Failed", jqXHR, textStatus, error);
      names = [];
      selectScreen();
    });
  };

  function navigateToGroup() {
    var newGroupName = $('#group-name').val();
    setPath(newGroupName);
    names = [];
    myName = undefined;
    selectScreen();
    return false;
  };

  function redrawMembers() {
    $('#group-members').html('');
    $.each(names, function (index, name) {
      var p = document.createElement('p');
      p.append(document.createTextNode(name));
      $('#group-members').append(p);
    });
  };

  function addMemberToGroup() {
    var newMemberName = $('#member-name').val();
    names.push(newMemberName);
    $('#member-name').val("");
    redrawMembers();
  };

  function sendResults() {
    var preferences = [];
    $.each($('#them').find('p'), function (index, element) {
      preferences.push($(element).text());
    });
    $.ajax({
      url: preferenceURL(),
      method: 'post',
      data: JSON.stringify({me: myName, preferences: preferences}),
      contentType: 'application/json',
      dataType: "json"
    }).done(function() {
      $('div.screen').hide();
      $('#thank-you').show();
    }).fail(function(jqXHR, textStatus, error) {
      $('div.screen').hide();
      $('#error').show();
    });
  };

  function switchPosition(element) {
    console.log("Switching element from " + $(element).data('location'));
    if (myName == undefined) {
      myName = $(element).find('p').text();
      moveTo(element, 'me');
      return;
    }
    if ($(element).data('location') == "me") {
      moveTo(element, 'unselected');
      myName = undefined;
      return; 
    }
    if ($(element).data('location') == "them") {
      moveTo(element, 'unselected');
    } else {
      moveTo(element, 'them');
    }
  };

  function moveTo(element, location) {
    if ($(element).data('location') != null) {
      var currentLocation = $(element).data('location');
      $(currentLocation).remove(element);
    }
    $("#" + location).append(element);
    $(element).data('location', location);
  };

  function createButton(name) {
    var button = document.createElement('div');
    var label = document.createElement('p');
    label.append(name);
    button.append(label);
    $(button).attr("class", "person");
    $(button).click(function() { switchPosition(button); });
    return button;
  };

  function populateNames() {
    console.log("Populating");
    $.each(names, function(index, name) {
      console.log(name);
      var button = createButton(name);
      moveTo(button, 'unselected');
    }); 
  }

  function selectScreen() {
    $('div.screen').hide();
    if (getPath() == "") {
      $('#select-group').show();
      $('#select-group input').focus();
      return;
    }
    $('#display-group-name').text(getGroupName());
    $('#loading').show();
    getGroupMembers().then(function(memberNames) {
      $('#loading').hide();
      names = memberNames.members;
      if (names.length == 0) {
        $('#populate-group').show();
        $('#populate-group input').focus();
        return;
      }
      populateNames();
      $('#enter-preferences').show();
    });
  }

  function start() {
    $.each([ 'select-group', 'populate-group' ], function(i,e) {
      $('#' + e).keypress(function(event) {
        if (event.keyCode == 13) {
          $('#' + e + " .default").click();
        }
      });
    });
    window.onhashchange = selectScreen;
    selectScreen();
  }

</script>
</html>
