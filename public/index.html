<!DOCTYPE html>
<html>
<head>
  <title>Dyad Finder</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <style>
    * {
    }

    body {
      background-image: linear-gradient(-90deg,#1251AE 0,#0074FF 50%,#1251AE 100%);
      font-family: 'Roboto';
      font-size: 22px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 500;
    }

    div.screen {
    }

    .headline {
      text-align: center;
    }

    #loading {
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    /**
     * Start Screen
     */

    .start {
      background-color: white;
      background-image: none;
      opacity: 1;
      padding: 25px 30px;
      margin: 2rem;
      width: 680px;
      display: flex;
      align-items: center;
    }

    .start-input-container {
      border-width: 0 0 2px;
      border-style: solid;
      border-image: linear-gradient(to right, #dee1e6, #fff) 1;
      width: 100%;
      align-items: center;
    }

    .start-input-container input {
      border: none;
      display: inline-block;
      width: 100%;
      font-size: 14px; 
    }

    .start-input-container input:focus {
      outline: none;
    }

    div .title {
      font-size: 18px;
      font-weight: 700;
      padding-bottom: 5px;
    }

    .start-button {
      width: 51px;
      height: 35px;
      font-size: 14px;
      background: #0074e0;
      border-radius: 4px;
      color: white;
      text-align: center;
      line-height: 35px;
      cursor: pointer;
      vertical-align: middle;
    }


    /**
     * Populate Group screen
     */
    #populate-group .title {
      color: white;
    }

    #group-members {
      background-color: white;
      opacity: 0.7;
      width: 680px;
      min-height: 100px;
      padding: 0.1rem;
      border-radius: 10px;
    }

    #group-members .member {
      margin: 0.5rem;
      background-color: #e2e2e2;
      padding: 0.25rem;
      border-radius: 10px;
    }

    #populate-group .input-container {
      width: 100%;
    }

    #populate-group .data-entry {
      display: flex;
      align-items: center;
      background-color: white;
      opacity: 1;
      padding: 0.5rem;
      margin: 0.5rem 0; 
      border-radius: 10px;
    }

    #populate-group input {
      border-width: 0 0 2px;
      border-style: solid;
      border-image: linear-gradient(to right, #dee1e6, #fff) 1;
      width: 100%;
    }

    #populate-group input:focus {
      outline: none;
    }

   .add-button {
      width: 51px;
      height: 35px;
      font-size: 14px;
      background: #0074e0;
      border-radius: 4px;
      color: white;
      text-align: center;
      line-height: 35px;
      cursor: pointer;
      vertical-align: middle;
    }

    .save-button {
      height: 35px;
      background: #003f80;
      font-size: 20px;
      text-align: center;
      cursor: pointer;
      vertical-align: middle;
      line-height: 35px;
      border-radius: 4px;
      width: 50%;
      color: white;
    }

    .save-button.disabled {
      background: #aaaaaa;
      cursor: not-allowed;
    }

    .button-holder {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /**
     * Enter preferences
     */
    #enter-preferences {
      width: 680px;
    }

    #enter-preferences div.preference-selector {
      background: white;
      opacity: 0.7;
      padding: 1rem;
    }

    #enter-preferences div.name-holder {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }

    div.person {
      height: 35px;
      line-height: 35px;
      border-radius: 4px;
      cursor: pointer;
      padding: 1rem;
      margin: 0.25rem;
      opacity: 1;
      color: black;
    }

    div.name-holder {
      border-radius: 10px;
      margin: 0.25rem;
      padding: 0.5rem;
    }

    #them {
      background: green;
      min-height: 75px;
    }

    #unselected {
      background: #0074ff;
      min-height: 75px;
    }

    div.them {
      background: #319872;
    }

    div.unselected {
      background: #00c4ff;
    }

    /**
     * Summary screen
     */
    #thank-you .next-steps {
      width: 680px;
      background: white;
      opacity: 0.7;
      padding: 1rem;
    }

    #thank-you .button-holder {
      margin: 1rem;
    }

  </style>
</head>
<body onload="start()">
  <div id="loading" style="display: none" class="screen">
    <style>
      .lds-grid {
        width: 80px;
        height: 80px;
        top: 25%;
        display: inline-block;
        position: relative;
      }

      .lds-grid div {
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #cef;
        animation: lds-grid 1.2s linear infinite;
      }
      .lds-grid div:nth-child(1) {
        top: 8px;
        left: 8px;
        animation-delay: 0s;
      }
      .lds-grid div:nth-child(2) {
        top: 8px;
        left: 32px;
        animation-delay: -0.4s;
      }
      .lds-grid div:nth-child(3) {
        top: 8px;
        left: 56px;
        animation-delay: -0.8s;
      }
      .lds-grid div:nth-child(4) {
        top: 32px;
        left: 8px;
        animation-delay: -0.4s;
      }
      .lds-grid div:nth-child(5) {
        top: 32px;
        left: 32px;
        animation-delay: -0.8s;
      }
      .lds-grid div:nth-child(6) {
        top: 32px;
        left: 56px;
        animation-delay: -1.2s;
      }
      .lds-grid div:nth-child(7) {
        top: 56px;
        left: 8px;
        animation-delay: -0.8s;
      }
      .lds-grid div:nth-child(8) {
        top: 56px;
        left: 32px;
        animation-delay: -1.2s;
      }
      .lds-grid div:nth-child(9) {
        top: 56px;
        left: 56px;
        animation-delay: -1.6s;
      }
      @keyframes lds-grid {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
    <div class="lds-grid"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
  </div>
  <div id="select-group" style="display: none" class="screen">
    <div class="headline">
      <h1>Dyad Finder</h1>
    </div>
    <div class="start">
      <div class="start-input-container">
        <div class="title">
          Select Group
        </div>
        <input type="text" id="group-name"></input>
      </div>
      <div class="start-button default" onclick="navigateToGroup()">GO</div>
    </div>
  </div>
  <div id="populate-group" style="display:none" class="screen">
    <div class="headline">
      <h1>Populate Group <span id="display-group-name"></span></h1>
    </div>
    <div class="title">
      Members
    </div>
    <div id="group-members">
    </div>
    <div class="data-entry">
      <div class="input-container">
        <input type="text" id="member-name"></input>
      </div>
      <div class="add-button default" onclick="addMemberToGroup()">ADD</div>
    </div>
    <div class="button-holder">
      <div onclick="updateGroup()" class="save-button">
        SAVE GROUP
      </div>
    </div>
  </div>
  <div id="enter-preferences" style="display: none" class="screen">
    <div class="headline">
      <h1 class="prompt">Select your Name</h1>
    </div>
    <div class="preference-selector">
      <div id="me">
      </div>
      <div class="title maybe-show-them" style="display: none">
        Preferred Dyad partners
      </div>
      <div id="them" class="name-holder maybe-show-them" style="display:none">
      </div>
      <div class="title">
        Group members
      </div>
      <div id="unselected" class="name-holder">
      </div>
      <div class="button-holder">
        <div onclick="sendResults()" class="save-button disabled">
          SAVE PREFERENCES 
        </div>
      </div>
    </div>
  </div>
  <div id="thank-you" style="display:none" class="screen">
    <div class="headline">
      <h1 class="prompt">Preferences submitted!</h1>
    </div>
    <div class="next-steps">
      <div class="button-holder">
        <div onclick="selectScreen()" class="save-button">
          ENTER MORE PREFERENCES
        </div>
      </div>
      <div class="button-holder">
        <div onclick="showMatches()" class="save-button">
          SHOW MATCHES
        </div>
      </div>
    </div>

  </div>
  <div id="error" style="display:none" class="screen">
    <div class="headline">
      <h1 class="prompt">Error - please try again</h1>
    </div>
  </div>
</body>
<script>

  var myName;

  var BASE_URL = "https://europe-west1-dyad-finder.cloudfunctions.net/dyad";

  var names = [
  ];

  function getPath() {
    if (window.location.protocol == "file:") {
      if (window.location.hash != "") {
        return window.location.hash.substring(1);
      }
      return window.location.hash;
    } else {
      return window.location.pathname.substring(1);
    }
  };

  function setPath(newGroupName) {
    var newPath;
    if (window.location.protocol == 'https:') {
      newPath = encodeURIComponent(newGroupName);
    } else {
      newPath = "#" + encodeURIComponent(newGroupName);
    }
    history.pushState({}, "Group " + newGroupName, newPath);
  };

  function getGroupName() {
    return decodeURIComponent(getPath());
  };

  function groupURL() {
    return BASE_URL + "/group/" + encodeURIComponent(getGroupName());
  };

  function preferenceURL() {
    return groupURL() + "/preference"; 
  };

  function getGroupMembers() {
    return $.ajax({
      url: groupURL(),
      dataType: 'json'
    }).then(function(data, textStatus, jqXHR) {
      return data;
    });
  };

  function updateGroup() {
    $('div.screen').hide();
    $('#loading').show();
    $.ajax({
      url: groupURL(),
      method: 'post',
      data: JSON.stringify({members: names}),
      contentType: 'application/json',
      dataType: "json"
    }).done(function() {
      $('#populate-group input, #populate-group button').prop("disabled", false);
      console.log("Selecting screen");
      selectScreen();
    }).fail(function(jqXHR, textStatus, error) {
      $('#populate-group input, #populate-group button').prop("disabled", false);
      console.log("Failed", jqXHR, textStatus, error);
      names = [];
      selectScreen();
    });
  };

  function navigateToGroup() {
    var newGroupName = $('#group-name').val();
    setPath(newGroupName);
    names = [];
    myName = undefined;
    selectScreen();
    return false;
  };

  function redrawMembers() {
    $('#group-members').html('');
    $.each(names, function (index, name) {
      var div = document.createElement('div');
      $(div).addClass("member");
      div.append(document.createTextNode(name));
      $('#group-members').append(div);
    });
  };

  function addMemberToGroup() {
    var newMemberName = $('#member-name').val();
    names.push(newMemberName);
    $('#member-name').val("");
    redrawMembers();
  };

  function resetPreferenceScreen() {
    $('#enter-preferences').find('h1.prompt').text('Select your Name');
    myName = null;
    $('#them').empty();
    $('#unselected').empty();
    $('#enter-preferences').find('.maybe-show-them').hide();
    $('div.preference-selector').find('div.save-button').addClass('disabled');
  }

  function sendResults() {
    if (myName == null) {
      return;
    }
    var preferences = [];
    $.each($('#them').find('div'), function (index, element) {
      preferences.push($(element).text());
    });
    $('div.screen').hide();
    $('#loading').show();
    $.ajax({
      url: preferenceURL(),
      method: 'post',
      data: JSON.stringify({me: myName, preferences: preferences}),
      contentType: 'application/json',
      dataType: "json"
    }).done(function() {
      $('div.screen').hide();
      resetPreferenceScreen();
      $('#thank-you').show();
    }).fail(function(jqXHR, textStatus, error) {
      $('div.screen').hide();
      resetPreferenceScreen();
      $('#error').show();
    });
  };

  function switchPosition(element) {
    console.log("Switching element from " + $(element).data('location'));
    if (myName == undefined) {
      myName = $(element).text();
      $(element).hide();
      $('#enter-preferences').find('h1.prompt').text('Select partners for ' + myName);
      $('div.preference-selector').find('div.save-button').removeClass('disabled');
      $('div.preference-selector').find('.maybe-show-them').show();
      return;
    }
    if ($(element).data('location') == "me") {
      moveTo(element, 'unselected');
      myName = undefined;
      return; 
    }
    if ($(element).data('location') == "them") {
      moveTo(element, 'unselected');
    } else {
      moveTo(element, 'them');
    }
  };

  function moveTo(element, location) {
    if ($(element).data('location') != null) {
      var currentLocation = $(element).data('location');
      $(element).removeClass(currentLocation);
      $(currentLocation).remove(element);
    }
    $("#" + location).append(element);
    $(element).addClass(location);
    $(element).data('location', location);
  };

  function createButton(name) {
    var button = document.createElement('div');
    button.append(name);
    $(button).addClass("person");
    $(button).addClass("unselected");
    $(button).click(function() { switchPosition(button); });
    return button;
  };

  function populateNames() {
    console.log("Populating");
    $.each(names, function(index, name) {
      console.log(name);
      var button = createButton(name);
      moveTo(button, 'unselected');
    }); 
  }

  function selectScreen() {
    $('div.screen').hide();
    if (getPath() == "") {
      $('#select-group').show();
      $('#select-group input').focus();
      return;
    }
    $('#display-group-name').text(getGroupName());
    $('#loading').show();
    getGroupMembers().then(function(memberNames) {
      $('#loading').hide();
      names = memberNames.members;
      if (names.length == 0) {
        $('#populate-group').show();
        $('#member-name').focus();
        return;
      }
      populateNames();
      $('#enter-preferences').show();
    });
  }

  function start() {
    $.each([ 'select-group', 'populate-group' ], function(i,e) {
      $('#' + e).keypress(function(event) {
        if (event.keyCode == 13) {
          $('#' + e + " .default").click();
        }
      });
    });
    window.onhashchange = selectScreen;
    selectScreen();
  }

</script>
</html>
